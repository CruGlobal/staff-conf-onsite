# Defines the view for the Meal Exemptions subform, nested in a Person's form.
form.instance_exec do
  inputs 'Meal Exemptions', class: 'meal_exemptions_attributes' do
    # This warning is hidden via Javascript
    h4 class: 'meal_exemptions_attributes__warning' do
      text_node 'Checked Meal Exemptions will be '
      strong 'deleted'
    end

    # A table of all of the meals this person has opted out of. Each row
    # represents a day, and each column a single meal exemption in that day
    table do
      thead do
        tr do
          th 'Date'
          MealExemption::TYPES.each { |t| th t }
        end
      end

      tbody do
        index = (MealExemption.last.try(:id) || -1) + 1

        # Creates a new row for each Date. ex:
        # |     Date     |  Breakfast  |   Lunch    |   Dinner   |
        # |  October 20  |  [EXEMPT]   |  [EXEMPT]  |  [EXEMPT]  |
        person.meal_exemptions.order_by_date.each do |date, types|
          tr do
            td { strong l date, format: :month }
            MealExemption::TYPES.each do |t|
              td do
                name = "#{person.class.name.underscore}[meal_exemptions_attributes]"
                name =
                  if types[t].present?
                    "#{name}[#{types[t].id}]".tap do |name|
                      insert_tag(
                        Arbre::HTML::Input,
                        type: :hidden,
                        name: "#{name}[id]",
                        value: types[t].id
                      )
                    end
                  else
                    "#{name}[#{index}]"
                  end

                # Delete record checkbox
                insert_tag(
                  Arbre::HTML::Input,
                  type: :checkbox,
                  name: "#{name}[_destroy]",
                  checked: types[t].blank?,
                  class: 'meal_exemptions_attributes__destroy_toggle'
                )

                insert_tag(
                  Arbre::HTML::Input,
                  type: :hidden,
                  name: "#{name}[date]",
                  value: date
                )
                insert_tag(
                  Arbre::HTML::Input,
                  type: :hidden,
                  name: "#{name}[meal_type]",
                  value: t
                )
              end
            end
          end
        end

        div(
          id: 'meal_exemptions_attributes__js',
          'data-nextindex' => index,
          'data-types' => MealExemption::TYPES.join(',')
        )
      end
    end
  end
end
